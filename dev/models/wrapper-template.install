#!/usr/bin/env bash
#
# wrapper-template.install - Self-contained installer template for Taskwarrior wrappers
# Version: 2.0.0
#
# This template demonstrates the v2.0.0 architecture for wrapper scripts:
# - Self-contained (works standalone without tw.py)
# - Optional tw-common.sh usage (graceful degradation)
# - Environment detection with defaults
# - Curl-based file downloads
# - Direct file placement in scripts/
# - PATH guidance for users
#
# USAGE:
#   bash yourwrapper.install install   - Install the wrapper
#   bash yourwrapper.install remove    - Remove the wrapper
#

set -euo pipefail

#------------------------------------------------------------------------------
# APPLICATION METADATA
#------------------------------------------------------------------------------

APPNAME="mywrapper"
VERSION="1.0.0"
BASE_URL="https://raw.githubusercontent.com/username/project/main"

#------------------------------------------------------------------------------
# ENVIRONMENT DETECTION
#------------------------------------------------------------------------------

: "${SCRIPTS_DIR:=$HOME/.task/scripts}"
: "${CONFIG_DIR:=$HOME/.task/config}"
: "${DOCS_DIR:=$HOME/.task/docs}"
: "${TASKRC:=$HOME/.taskrc}"
: "${TW_DEBUG:=0}"

#------------------------------------------------------------------------------
# LIBRARY SOURCING (OPTIONAL)
#------------------------------------------------------------------------------

if [[ -f "${TW_COMMON:-}" ]]; then
    source "$TW_COMMON"
    HAVE_TW_COMMON=1
else
    HAVE_TW_COMMON=0
    
    tw_msg() { echo "[tw] $*"; }
    tw_success() { echo "[tw] ✓ $*"; }
    tw_error() { echo "[tw] ✗ $*" >&2; }
    tw_warn() { echo "[tw] ⚠ $*" >&2; }
    tw_debug() { [[ "${TW_DEBUG:-0}" == "1" ]] && echo "[tw-debug] $*" >&2 || true; }
fi

#------------------------------------------------------------------------------
# INSTALLATION FUNCTION
#------------------------------------------------------------------------------

install() {
    tw_msg "Installing $APPNAME v$VERSION..."
    
    # Create directories
    mkdir -p "$SCRIPTS_DIR" "$CONFIG_DIR" "$DOCS_DIR"
    
    # Download wrapper script
    tw_msg "Downloading wrapper script..."
    
    if [[ $HAVE_TW_COMMON -eq 1 ]] && type tw_curl_and_place &>/dev/null; then
        tw_curl_and_place "$BASE_URL/${APPNAME}" "$SCRIPTS_DIR" || {
            tw_error "Failed to download wrapper script"
            return 1
        }
    else
        if ! curl -fsSL "$BASE_URL/${APPNAME}" -o "$SCRIPTS_DIR/${APPNAME}"; then
            tw_error "Failed to download wrapper script"
            return 1
        fi
    fi
    
    # Make wrapper executable
    chmod +x "$SCRIPTS_DIR/${APPNAME}"
    tw_debug "Made wrapper executable"
    
    # Download config file (if exists)
    if [[ $HAVE_TW_COMMON -eq 1 ]] && type tw_curl_and_place &>/dev/null; then
        tw_curl_and_place "$BASE_URL/${APPNAME}.rc" "$CONFIG_DIR" 2>/dev/null || true
    else
        curl -fsSL "$BASE_URL/${APPNAME}.rc" -o "$CONFIG_DIR/${APPNAME}.rc" 2>/dev/null || true
    fi
    
    # Add config include if config was downloaded
    if [[ -f "$CONFIG_DIR/${APPNAME}.rc" ]]; then
        if [[ $HAVE_TW_COMMON -eq 1 ]] && type tw_add_config &>/dev/null; then
            tw_add_config "include $CONFIG_DIR/${APPNAME}.rc"
        else
            if [[ -f "$TASKRC" ]] && ! grep -q "include $CONFIG_DIR/${APPNAME}.rc" "$TASKRC"; then
                echo "include $CONFIG_DIR/${APPNAME}.rc" >> "$TASKRC"
            fi
        fi
    fi
    
    # Download README
    if [[ $HAVE_TW_COMMON -eq 1 ]] && type tw_curl_and_place &>/dev/null; then
        tw_curl_and_place "$BASE_URL/README.md" "$DOCS_DIR" "${APPNAME}_README.md" 2>/dev/null || true
    else
        curl -fsSL "$BASE_URL/README.md" -o "$DOCS_DIR/${APPNAME}_README.md" 2>/dev/null || true
    fi
    
    # Track in manifest
    if [[ $HAVE_TW_COMMON -eq 1 ]] && type tw_manifest_add &>/dev/null; then
        tw_manifest_add "$APPNAME" "$VERSION" "$SCRIPTS_DIR/${APPNAME}"
        [[ -f "$CONFIG_DIR/${APPNAME}.rc" ]] && \
            tw_manifest_add "$APPNAME" "$VERSION" "$CONFIG_DIR/${APPNAME}.rc"
        [[ -f "$DOCS_DIR/${APPNAME}_README.md" ]] && \
            tw_manifest_add "$APPNAME" "$VERSION" "$DOCS_DIR/${APPNAME}_README.md"
    fi
    
    tw_success "Installed $APPNAME v$VERSION"
    tw_msg "Wrapper script: $SCRIPTS_DIR/${APPNAME}"
    
    # Check if scripts dir is in PATH
    if [[ ":$PATH:" != *":$SCRIPTS_DIR:"* ]]; then
        tw_warn "Add $SCRIPTS_DIR to your PATH to use '$APPNAME' command"
        tw_msg "Add this to your ~/.bashrc or ~/.zshrc:"
        tw_msg "  export PATH=\"\$PATH:$SCRIPTS_DIR\""
    else
        tw_msg "You can now use: $APPNAME"
    fi
    
    return 0
}

#------------------------------------------------------------------------------
# REMOVAL FUNCTION
#------------------------------------------------------------------------------

remove() {
    tw_msg "Removing $APPNAME..."
    
    # Use manifest-based removal if available
    if [[ $HAVE_TW_COMMON -eq 1 ]] && type tw_uninstall_app &>/dev/null; then
        tw_uninstall_app "$APPNAME"
        return $?
    fi
    
    # Fallback: manual removal
    local removed=0
    
    if [[ -f "$SCRIPTS_DIR/${APPNAME}" ]]; then
        rm -f "$SCRIPTS_DIR/${APPNAME}"
        tw_debug "Removed: $SCRIPTS_DIR/${APPNAME}"
        removed=1
    fi
    
    if [[ -f "$CONFIG_DIR/${APPNAME}.rc" ]]; then
        rm -f "$CONFIG_DIR/${APPNAME}.rc"
        tw_debug "Removed: $CONFIG_DIR/${APPNAME}.rc"
        removed=1
        
        # Remove config line from .taskrc
        if [[ -f "$TASKRC" ]]; then
            grep -v "include $CONFIG_DIR/${APPNAME}.rc" "$TASKRC" > "$TASKRC.tmp" || true
            mv "$TASKRC.tmp" "$TASKRC"
        fi
    fi
    
    if [[ -f "$DOCS_DIR/${APPNAME}_README.md" ]]; then
        rm -f "$DOCS_DIR/${APPNAME}_README.md"
        tw_debug "Removed: $DOCS_DIR/${APPNAME}_README.md"
        removed=1
    fi
    
    if [[ $removed -eq 1 ]]; then
        tw_success "Removed $APPNAME"
        return 0
    else
        tw_warn "No files found to remove for $APPNAME"
        return 1
    fi
}

#------------------------------------------------------------------------------
# MAIN ENTRY POINT
#------------------------------------------------------------------------------

main() {
    case "${1:-}" in
        install)
            install
            ;;
        remove)
            remove
            ;;
        *)
            echo "Usage: $0 {install|remove}"
            echo ""
            echo "Examples:"
            echo "  $0 install   - Install $APPNAME wrapper"
            echo "  $0 remove    - Remove $APPNAME wrapper"
            exit 1
            ;;
    esac
}

main "$@"
