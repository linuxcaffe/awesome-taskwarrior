#!/bin/bash

APPNAME="tw-recurrence"
SHORT_NAME="recurrence"
REPO_URL="https://github.com/linuxcaffe/tw-recurrence_overhaul-hook"

# Source common library
source "$(dirname "$0")/../lib/tw-common.sh"

install() {
    echo "Installing ${APPNAME}..."
    
    # Check dependencies
    tw_check_python_version 3.6 || return 1
    tw_check_taskwarrior_version 2.6.2 || return 1
    
    # Clone repository to ~/.task/hooks/recurrence/
    tw_clone_to_project hook "$SHORT_NAME" "$REPO_URL" || return 1
    
    local project_dir="${HOOKS_DIR}/${SHORT_NAME}"
    
    # Install hooks (creates symlinks in ~/.task/hooks/)
    tw_symlink_hook "$project_dir" "on-add_recurrence.py" || return 1
    tw_symlink_hook "$project_dir" "on-modify_recurrence.py" || return 1
    tw_symlink_hook "$project_dir" "on-exit_recurrence.py" || return 1
    
    # Add UDA configuration
    tw_add_config "uda.recur_type.type=string"
    tw_add_config "uda.recur_type.label=Recurrence Type"
    tw_add_config "uda.recur_type.values=chained,periodic"
    tw_add_config "uda.recur_template.type=string"
    tw_add_config "uda.recur_template.label=Template UUID"
    tw_add_config "uda.recur_instance.type=numeric"
    tw_add_config "uda.recur_instance.label=Instance Number"
    
    # Add custom reports
    tw_add_config "report.recurring.description=Recurring task templates"
    tw_add_config "report.recurring.columns=id,description,recur,recur_type"
    tw_add_config "report.recurring.filter=status:pending +TEMPLATE"
    
    echo "✓ Installed ${APPNAME}"
    echo "  Hooks installed in: ${HOOKS_DIR}/"
    echo "  Project files in: ${project_dir}"
    echo "  Logs will go to: ${LOGS_DIR}/${SHORT_NAME}/"
    return 0
}

uninstall() {
    echo "Uninstalling ${APPNAME}..."
    
    # Remove hooks
    tw_remove_hook "on-add_recurrence.py"
    tw_remove_hook "on-modify_recurrence.py"
    tw_remove_hook "on-exit_recurrence.py"
    
    # Remove configuration
    tw_remove_config "uda.recur_type"
    tw_remove_config "uda.recur_template"
    tw_remove_config "uda.recur_instance"
    tw_remove_config "report.recurring"
    
    # Remove project directory
    rm -rf "${HOOKS_DIR}/${SHORT_NAME}"
    
    echo "✓ Uninstalled ${APPNAME}"
    return 0
}

test() {
    echo "Testing ${APPNAME}..."
    
    local project_dir="${HOOKS_DIR}/${SHORT_NAME}"
    
    # Test hooks exist and are executable
    tw_test_hook "on-add_recurrence.py" || return 1
    tw_test_hook "on-modify_recurrence.py" || return 1
    tw_test_hook "on-exit_recurrence.py" || return 1
    
    # Test configuration
    tw_test_config "uda.recur_type.type" "string" || return 1
    
    # Test project directory exists
    if [ ! -d "$project_dir" ]; then
        tw_error "Project directory not found: $project_dir"
        return 1
    fi
    
    echo "✓ All tests passed"
    return 0
}

# Main entry point
if [ "${BASH_SOURCE[0]}" = "$0" ]; then
    : ${INSTALL_DIR:=~/.task}
    : ${HOOKS_DIR:=~/.task/hooks}
    : ${SCRIPTS_DIR:=~/.task/scripts}
    : ${CONFIG_DIR:=~/.task/config}
    : ${LOGS_DIR:=~/.task/logs}
    : ${TASKRC:=~/.taskrc}
    : ${TW_DEBUG:=0}
    
    case "${1:-install}" in
        install) install ;;
        uninstall) uninstall ;;
        test) test ;;
        *)
            echo "Usage: $0 {install|uninstall|test}" >&2
            exit 1
            ;;
    esac
fi
